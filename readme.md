  ----------------------------------------------------------------------------------------
  MODULO 2- ENTORNOS DE ANALISIS DE MALWARE
  ![](Pictures/10000000000004B0000003202F9C5FD5.png){width="16.806cm" height="15.713cm"}
  Ramon Gonzalez Gaztelupe
  ----------------------------------------------------------------------------------------

Se nos pide realizar un modulo de análisis que abra archivos .mkv en en
VLC en guest, tendremos que usar un PoC que aprovecha una vulnerabilidad
de arbitrary code execution en la version 2.2.8 de VLC la cual deberá
esta instalada previamente en nuestro guest con Windows 10 x64, la
vulnerabilidad funciona en las dos arquitecturas, tanto en x64 como x32.

En nuestro caso usaremos x64:

<https://www.exploit-db.com/exploits/44979>

<https://get.videolan.org/vlc/2.2.8/>

En nuestra maquina Guest tendremos que instalar primeramente la versión
VLC 2.2.8 afectada por la vulnerabilidad:

![](Pictures/10000201000001F100000181E337C79B.png){width="6.029cm"
height="4.251cm"}

Desactivaremos el análisis en tiempo real de Windows Defenfer y sus
diferentes protecciones contra exploits, para evitar intercepcciones.

Para evitar que windows descargue actualizaciones y afecte de alguna
forma a la versión de VLC y al propio windows defender.

Para ello desactivaremos desde windows en Servicios → Windows Update
Properties → Disabled

![](Pictures/10000201000002A1000001C794553FDB.png){width="10.072cm"
height="6.241cm"}

En el host hemos deshabilitado la opción de enrutamiento hacia internet
desde el guest para impedir el acceso a través del gateway.

Modificamos desde conf/routing.conf → route=none

![](Pictures/1000020100000066000000214B0E4C59.png){width="2.565cm"
height="0.967cm"}

Nuestro modulo de análisis tendremos que dejarlo en el directorio
analyzer/windows/modules/packages → mkv_exploit.py a través del usuario
cape

![](Pictures/100002010000017F000000125B81D292.png){width="11.208cm"
height="0.619cm"}

Arranco un server desde Mac para descargar en Ubuntu Capev2 nuestro
diseño del modulo

![](Pictures/10000201000002570000009DDE15A58D.png){width="12.741cm"
height="3.022cm"}

![](Pictures/100002010000036800000081F191154E.png){width="12.869cm"
height="2.482cm"}

El tamaño máximo de entrada de archivos a través de cape-web tendremos
que modificarlo ya que da error conf/web.conf → max_sample_size

![](Pictures/10000201000000CA0000006AFFF7BB4E.png){width="5.186cm"
height="2.944cm"}

Reiniciamos CAPEv2 con este script → ./reinicar_cape

![](Pictures/100002010000011A00000100154424A2.png){width="5.426cm"
height="4.33cm"}

El exploit tal y como se encuentra en exploit-db no requiere ninguna
modificarle nada, lo ejecutaremos con python2 por la compatibilidad y
nos generara 2 archivos .mkv

![](Pictures/10000201000001B50000007387617870.png){width="10.617cm"
height="3.041cm"}

Nos genera 2 archivos .mkv, el primero será el que tendremos que dropear
al programa y el segundo un fichero auxiliar que requiere el propio
exploit y que deberá estar en el mismo directorio que el poc.mkv *(el
archivo pesa algo mas de 1GB)*

![](Pictures/100002010000051A000002E883BD89F1.png){width="12.815cm"
height="6.53cm"}Utiliza una cadena gadgets rop para preparar los
registros del procesador*(por la convención de llamadas x64)* con los
valores necesarios y hacer jmp a VirtualProtect(), y dar permisos de
ejecución al rango de direcciones en el que esta alocado el shellcode:

![](Pictures/1000020100000652000000E0F19F4033.png){width="14.325cm"
height="2.586cm"}

La shellcode que incluye abrirá una calc.exe:

![](Pictures/10000201000004CE0000013461BA1672.png){width="14.263cm"
height="3.646cm"}

Para el modulo de análisis hemos analizado otros parecidos que
encontramos en el mismo directorio, hemos añadido una opción que
funciona únicamente a la hora de usar el exploit:

Si enviamos al análisis un archivo .zip lo descomprimirá en la misma
ubicación y le para como argumento a la ejecución de VLC el archivo
poc.mkv.

De lo contrario podemos enviar cualquier archivo .mkv que lo ejecutara
en VLC:

Tendremos que elegir el análisis mkv_exploit antes de realizar el envío
para ser detectado.

![](Pictures/10000201000006B60000054C8F64F5D3.png){width="15.362cm"
height="13.065cm"}

Librerías importadas:

![](Pictures/100002010000060C0000008C9D1F5F78.png){width="15.452cm"
height="1.536cm"}

Primero realizo un video de un archivo .mkv con un videoclip de una
canción:

![](Pictures/1000020100000AE8000003980D28CE10.png){width="16.185cm"
height="5.6cm"}

Observamos el análisis:

![](Pictures/100002010000077200000036CEE3C41C.png){width="16.143cm"
height="0.748cm"}

![](Pictures/1000020100000DCC0000076A974C5D5D.png){width="16.344cm"
height="10.444cm"}

![](Pictures/1000020100000B3E0000079CB37A615E.png){width="16.078cm"
height="10.516cm"}

![](Pictures/1000020100000B2C000007366359C53C.png){width="15.886cm"
height="9.109cm"}

Para probar el análisis con el exploit, comprimimos en un archivo zip
los 2 archivos .mkv que nos genera el exploit de VLC y lo enviamos
eligiendo el análisis mkv_exploit igual que con el anterior ejemplo:

![](Pictures/10000201000003FE0000025CD529DF2F.png){width="9.603cm"
height="5.369cm"}

Enviamos el archivo zip a través de la interfaz web:

![](Pictures/1000020100000AE600000394067CEA8A.png){width="16.014cm"
height="5.581cm"}

![](Pictures/1000020100000B220000071EABBF8BD2.png){width="16.18cm"
height="9.707cm"}

![](Pictures/1000020100000BBE000007283E4F1BA5.png){width="15.759cm"
height="9.899cm"}
