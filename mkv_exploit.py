from lib.common.abstracts import Package
from zipfile import ZipFile
import os

#mkv_exploit.py -> analyzer/windows/modules/packages/

# analyzer/windows/lib/core/packages.py
#elif file_name.endswith(".mkv"):
#        return "mkv"

#
# os.path.join()

#C:\\Users\\raj\\AppData\\Local\\Temp\\

#OPTIONS -> zip=1

#        path_zip = os.path.join(path_total[0],"exploit.zip")

class mkv_exploit(Package):

    PATHS = [
        ("ProgramFiles", "VideoLAN", "VLC", "vlc.exe"),
    ]

    def start(self, path):

        #obtenemos el path de VLC
        vlc = self.get_path("vlc.exe")

        #split nos divide en una lista el path
        #de tal manera que tendriamos
        #path_total[0] seria el directorio
        #path_total[1] seria el archivo
        path_in = f"{path}"
        path_total = os.path.split(path_in)

        #comprobamos que path finalize en .mkv 
        #si no es asi damos por hecho que es .zip y descomprimimos todo el contenido en la
        #misma ubicacion, de lo contrario suponemos que obtenemos un .mkv y lo ejecutamos en VLC
        if not path.endswith(".mkv"):
            
            #creamos un objeto para acceder a el
             with ZipFile(path, 'r') as zObject:
                    
                    #iteramos todos los elementros que contenga
                    for _ in zObject.infolist():
                        #el HEAD del path-> path_total[0]
                        # contraseÃ±a-> None
                        zObject.extractall(path_total[0],None)

            #ejecutamos vlc con el archvio poc.mkv
             return self.execute(vlc, os.path.join(path_total[0],"poc.mkv"), os.path.join(path_total[0],"poc.mkv"))
           
        else:
                return self.execute(vlc, f'"{path}"', path)
            

